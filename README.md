# ukrsib

Тестовое задание Укрсиббанк

Задание: Необходимо прочитать xml-файл и сложить данные в произвольную СУБД , данный файл может быть размера до 1Г. Требование к проекту:

•	проект должен собираться (maven\gradle)

•	должен включать в себя jUnit-тесты

•	ORM (См. вложенный файл: Java_test.xml)

Пример кода следует выложить на gitlab, github или bitbacket.

------------------------------------------------------------------

В этом тексте описываются основные особенности работы и собраны только основные выдержки из комментариев классов приложения.

1.	Предположения

Замечания разработчика

Прошу учесть, что при условии доступа к реальной информации, все решения, принятые в дальнейшем на основании предположений, могли бы отличаться.

1.1.	Генерация id другими приложениями будет такой же как в этом или это будет единственное приложение для вставки в эту базу данных. У транзакций в фале нет id, даты и времени проведения, что не позволяет делать дальнейших предположений. Возможно было бы целесообразно в id кодировать дату и время начала импорта сохраняя этот код во временный файл. Но для простоты используется генерация id транзакций указанная в разделе 2.

1.2.	Место проведения транзакции – может быть длинным полем с указанием страны, города, улицы и т.п. Поэтому выделяется в отдельную таблицу.

2.	Таблицы

transactions (id, amount, currency, card, client_id, place_id)
clients (inn, first_name, last_name, middle_name)
places (id, place)

Для использования пакетной вставки для id не используется автогенерация, кроме таблицы places, где используется SEQUENCE

Trans

Класс-сущность для таблицы transactions

id рассчитывается на основании значений всех полей и порядкового номера в файле

Связь с таблицей клиентов однонаправленная - ManyToOne - множество транзакций может быть связано с одним лицом

Связь с таблицей мест транзакций однонаправленная - ManyToOne - множество транзакций может быть осуществлено в одном месте

Clients

Класс-сущность для таблицы clients

В качестве id выбран естественный ключ inn

Связь с таблицей транзакций однонаправленная со стороны транзакций

Изменен стандартный SQL-запрос вставки в БД на INSERT IGNORE ..., что дает возможность не откатывать JPA-транзакцию, когда конкурирующая транзакция добавила этого же Клиента между SELECT и INSERT текущей JPA-транзакции.

Places

Класс-сущность для таблицы places

id – автогенерация SEQUENCE

placeName – второй естественный ключ

Связь с таблицей транзакций однонаправленная со стороны транзакций

Изменен стандартный SQL-запрос вставки в БД на INSERT IGNORE ..., что дает возможность не откатывать JPA-транзакцию, когда конкурирующая транзакция добавила этого же Клиента между SELECT и INSERT текущей JPA-транзакции.


3.	Как работает приложение и сервисы

MainService

Осуществляет последовательные действия по запуску необходимых сервисов и проверку их работы
 1. Устанавливает SQL-триггеры предотвращающие удаление строк или изменение ключевых полей используемых таблиц
 2. Запускает ParseService - парсер файла данных в отдельном потоке. Если парсер запускается в режиме предварительной проверки, ожидает завершение проверки.
 3. Запускает вычисленное (не менее 1-го и не более количества выделенных логических процессоров минус один) количество потоков сохранения данных SaveService с разницей в 1 секунду, чтобы не запускать множество потоков для небольших файлов.
 4. Ожидает завершение работы всех сервисов. Сервисы могут быть остановлены принудительно при превышении критического порога ошибок (значение устанавливается в application.properties)
 5. Удаляет SQL-триггеры (пункт 1), только если все транзакции добавлены в БД
 6. Предлагает запустить приложение еще раз, если не все транзакции добавлены в БД

QueryService

Сервис установки SQL-триггеров для предотвращения удаления или изменения ключевых полей во время обновления

Триггеры удаляются после полного добавления информации из XML-файла

Эти триггеры необходимы в том случае, если таблицы базы SQL создаются с параметрами ON UPDATE CASCADE и/или ON DELETE CASCADE

Кроме того, триггер places_update_trigger_7did39f3 предотвращает изменения полей таблицы places чтобы другие пользователи не изменили ключевое поле place во время работы или между запусками после сбоя приложения.

Если использование таких триггеров неприемлемо исходя из бизнес-логики, можно использовать дополнительную таблицу аудита содержащую foreign keys для ключевых полей

ParseService

Разбирает входящий файл на транзакции и складывает их в хранилище StoreService. После полного разбора входящего файла сообщает о завершении своей работы.

Если приложение запущено с настройкой предварительной проверки входящего файла, сначала проверяет файл без отправки данных в StoreService. При отсутствии ошибок запускает себя рекурсивно в основном режиме работы, иначе сообщает о всех ошибках и принудительно останавливает приложение с помощью специального флага StoreService.

SaveService

Потоки SaveService запрашивают транзакции из хранилища, формируют пакеты для пакетной вставки и передают пакет в TransService для вставки в базу данных.

При неудачной попытке SaveService повторяет попытки до максимального установленного значения. После последней неудачной попытки возвращает транзакции в хранилище для повтора попыток согласно очереди.

При удачной вставке удаляет транзакции текущего пакета и запрашивает новые транзакции для следующего.

После завершения работы ParseService забирают последние транзакции из хранилища и после удачного добавления в базу данных завершают свою работу. При неудачных попытках повторяют попытки пока хранилище не закрыто.

StoreService

Содержит конкурентную очередь и методы добавления и извлечения для работы ParseService и SaveService, а так же флаг состояния ParseService, флаг своего состояния и счетчик неудачных пакетов. При превышении счетчиком неудачных пакетов максимального допустимого значения ошибок прекращает прием и выдачу данных устанавливая флаг своего состояния. В таком случае все сервисы прекращают свою работу и приложение завершается. Это сделано, чтобы остановить приложение при продолжительной недоступности SQL-сервера.

TransService

Сохраняет транзакции в БД

При любом исключении откатывает JPA-транзакцию.

Isolation.READ_COMMITTED в сочетании с триггерами в конечном результате гарантируют наличие данных в БД

Измененные SQL-запросы (INSERT IGNORE) для Клиентов и Мест позволяют не откатывать JPA-транзакцию, когда конкурирующая транзакция добавила этого же Клиента или Место между SELECT и INSERT текущей JPA-транзакции – существенно снижает количество откатов.


Приложение не будет обновлять значения неключевых полей Клиентов, если они были изменены другими пользователями (так как включен кэш 2-го уровня).

При запуске после сбоя, приложение продолжит добавление транзакций в базу данных, проверяя те, которые уже есть в базе данных и обновит значения неключевых полей, если они были изменены другими пользователями.

4.	Настройка приложения

Основные настройки с комментариями находятся в файле application.properties

Используется batch insert и упорядоченная вставка дочерних объектов

Включен кэш 2-го уровня

Отключены ненужные Join

5.	Тесты

Необходимо подключение к MySQL для системных и интеграционных тестов

Разбиты по пакетам как в приложении

В названии класса добавлено Tests – интеграционные тесты соответствующих сервисов

В названии класса добавлено UnitTests – unit тесты сервисов и сущностей

Системные тесты в отдельном пакете systemtests

EtcTests – прочие тесты

В комментариях к каждому тесту описано что он проверяет и как работает.

Тестовые сьюты запускают наборы соответствующих тестов (Unit, Integration, System, All)

LongTests - могут занимать продолжительное время из-за возможного большого объема данных (настраивается в классе). Не входят ни в один сьют. Не тестируют ничего, что не тестировали бы основные тесты. Можно использовать как бенчмарки. Частичная генерация данных.

DatasourceProxyBeanPostProcessor – заимствованный класс для отображения sql-запросов в консоли с отражением использования batch. По умолчанию отображение выключено. Включается в самом классе. Для тестов не принципиально.

6.	Maven

Сборка приложения со всеми зависимостями:

mvn package spring-boot:repackage

Сборка и запуск приложения со всем зависимостями:

mvn package spring-boot:repackage spring-boot:run

Один долгий тест, не вошедший в основные тесты, с настраиваемым количеством данных LongTests.java:

mvn failsafe:integration-test

7. Проверено

Сборка Maven и работа приложения проверена с MySQL 5.7 и MySQL 8 на:

Windows Server 2008 R2

Windows 8.1

Windows 10

Ubuntu 20


Не гарантируется работа приложения на других видах баз данных, так как используются специфические SQL-запросы INSERT и триггеры. В таком случае необходимо немного подправить запросы под базу данных.
